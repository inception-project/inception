// Licensed to the Technische Universität Darmstadt under one
// or more contributor license agreements.  See the NOTICE file
// distributed with this work for additional information
// regarding copyright ownership.  The Technische Universität Darmstadt 
// licenses this file to you under the Apache License, Version 2.0 (the
// "License"); you may not use this file except in compliance
// with the License.
//  
// http://www.apache.org/licenses/LICENSE-2.0
// 
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

[[sect_security_authentication_oauth2]]
= OAuth2/OIDC authentication

{product-name} can authenticate a user against a OAuth2/OIDC-compatible identity provider. OAuth2/OIDC providers can be configured alongside the usual form-based login and SAML2. 
It is **not** compatible with the <<sect_security_authentication_preauth,external pre-authentication>> and does not require setting the `auth.mode` property.

The following example configuration declares an OAuth2 service connection named `inception-client-oauth`
which uses a Keycloak instance configured for OAuth2 running at 
`http://localhost:8180/realms/inception-demo`. The OAuth2 support of {product-name} should work with
any OAuth2/OIDC-compatible identity provider. For more details, please
refer to the link:https://docs.spring.io/spring-security/reference/servlet/oauth2/client/authorization-grants.html[Spring Security OAuth2 documentation].

.Example: Authenticate against a local Keycloak
----
spring.security.oauth2.client.registration.inception-client-oauth.client-name=Keycloak
spring.security.oauth2.client.registration.inception-client-oauth.client-id=inception-client-oauth
spring.security.oauth2.client.registration.inception-client-oauth.client-secret=ENCRYPTED_CLIENT_SECRET
spring.security.oauth2.client.registration.inception-client-oauth.scope=openid, profile
spring.security.oauth2.client.registration.inception-client-oauth.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.inception-client-oauth.redirect-uri=http://localhost:8080/login/oauth2/code/inception-client-oauth
spring.security.oauth2.client.provider.inception-client-oauth.issuer-uri=http://localhost:8180/realms/inception-demo 
spring.security.oauth2.client.provider.inception-client-oauth.user-name-attribute=preferred_username
----

NOTE: The following instructions run Keycloak in development mode. This is **not** meant for
      production, only for testing. For how to properly set up a production-level Keycloak server, please
      refer to the official documentation of Keycloak.

If you want to try this with a local testing instance of Keycloak, you can do this:

* Download link:https://www.keycloak.org[Keycloak]
* Run it using `./kc.sh start-dev --http-port 8180`
* Configure a new realm called `inception-demo`
* Define a new client `inception-client-oauth` and set the *Valid redirection URI* to `http://localhost:8080/login/oauth2/code/inception-client-oauth`.
* Replace the `ENCRYPTED_CLIENT_SECRET` in the example configuration above with the client secret from 
  the *Credentials* tab of the client in Keycloak.
* Add a new user in the *Manage users* area in Keycloak.

When you restart {product-name} and access the login page now, it should offer a login option called
*Keycloak*. You can change the label of that option by changing the 
`security.oauth2.client.registration.inception-client-oauth.client-name` setting.

[[sect_security_authentication_oauth2_role_mapping]]
== Group-to-role mapping

By default, every user that successfully authenticates via OAuth2/OIDC receives `ROLE_USER` and can
log in. Additional {product-name} roles (`ROLE_ADMIN`, `ROLE_PROJECT_CREATOR`, `ROLE_REMOTE`) must
then be assigned manually by an administrator inside the application.

Alternatively, {product-name} can derive roles automatically from an OIDC token claim (typically
named `groups`) by mapping group names to {product-name} roles. This is configured with the
`security.oauth2.roles.*` properties.

.Group-to-role mapping properties
[cols="2,1,3"]
|===
|Property |Default |Description

|`security.oauth2.roles.enabled`
|`false`
|Set to `true` to activate group-to-role mapping. When disabled, all authenticated users receive `ROLE_USER` regardless of their group memberships.

|`security.oauth2.roles.claim`
|`groups`
|Name of the OIDC token claim that contains the user's group memberships.

|`security.oauth2.roles.admin`
|(none)
|Group name (or path) that grants `ROLE_ADMIN`.

|`security.oauth2.roles.user`
|(none)
|Group name (or path) that grants `ROLE_USER`.

|`security.oauth2.roles.project-creator`
|(none)
|Group name (or path) that grants `ROLE_PROJECT_CREATOR`.

|`security.oauth2.roles.remote`
|(none)
|Group name (or path) that grants `ROLE_REMOTE`.
|===

NOTE: When `security.oauth2.roles.enabled=true` and a user's token does not match any configured
group, login is denied with an access-denied error.

The following example maps Keycloak group paths (which include a leading `/`) to {product-name}
roles. The `groups` claim must be configured as a protocol mapper on the Keycloak client.

.Example: Map Keycloak groups to {product-name} roles
----
security.oauth2.roles.enabled=true
security.oauth2.roles.claim=groups
security.oauth2.roles.admin=/INCEPTION_ADMIN
security.oauth2.roles.user=/INCEPTION_USER
security.oauth2.roles.project-creator=/INCEPTION_PROJECT_CREATOR
security.oauth2.roles.remote=/INCEPTION_REMOTE
----

NOTE: Keycloak group claims use the full group path (e.g. `/INCEPTION_ADMIN`), not just the group
      name. Other identity providers may use plain group names without the leading `/`. Check the
      actual claim value in the token issued by your provider and set the properties accordingly.
